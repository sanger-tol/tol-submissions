openapi: 3.0.0
info:
  title: Tree of Life Submissions API
  description: API for ToL Submissions
  contact:
    email: tol-platforms@sanger.ac.uk
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
  version: 1.0.1
servers:
  - url: http://0.0.0.0:8081/api/v1
tags:
- name: submitters
  description: Submitting
- name: auth
  description: Authorisation
paths:
  /manifests:
    post:
      security:
        - ApiKeyAuth: []
      tags:
      - submitters
      summary: Upload a JSON manifest
      description: |
        Upload a manifest in JSON format
      operationId: upload_manifest_json
      requestBody:
        description: Manifest to add
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ManifestIn'
      responses:
        "200":
          description: manifest created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestOut'
                x-content-type: application/json
        "400":
          description: invalid input, object invalid, or item already exists
        "403":
          description: user not authorised to use this function
      x-openapi-router-controller: swagger_server.controllers.submitters_controller
  /manifests/upload-excel:
    post:
      security:
        - ApiKeyAuth: []
      tags:
      - submitters
      summary: Upload an excel manifest
      description: |
        Uploads an Excel manifest to this service
      operationId: upload_manifest_excel
      parameters:
        - name: projectName
          in: query
          description: the name of the project
          required: false
          style: form
          explode: true
          schema:
            type: string
      requestBody:
        content:
          multipart/form-data:
            schema:
              x-body-name: excelFile
              type: object
              properties:
                excelFile:
                  type: string
                  format: binary
              required:
                - excelFile
      responses:
        "200":
          description: manifest created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestOut'
                x-content-type: application/json
        "400":
          description: invalid input, object invalid, or item already exists
        "403":
          description: user not authorised to use this function
      x-openapi-router-controller: swagger_server.controllers.submitters_controller
  /manifests/validate:
    post:
      security:
        - ApiKeyAuth: []
      tags:
      - submitters
      summary: Upload and immediately validate a JSON manifest
      description: |
        Upload a manifest in JSON format and validate it (convenience method)
      operationId: submit_and_validate_manifest_json
      requestBody:
        description: Manifest to upload and validate
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ManifestIn'
      responses:
        "200":
          description: manifest validated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestValidationResult'
                x-content-type: application/json
        "400":
          description: invalid input, object invalid, or item already exists
        "403":
          description: user not authorised to use this function
      x-openapi-router-controller: swagger_server.controllers.submitters_controller
  /manifests/{manifestId}:
    get:
      security:
        - ApiKeyAuth: []
      tags:
      - submitters
      summary: Gets a manifest
      description: |
        Returns a manifest that has been uploaded (and possibly validated and had IDs generated)
      operationId: get_manifest
      parameters:
      - name: manifestId
        in: path
        description: a manifest ID (given when manifest created)
        required: true
        style: simple
        explode: true
        schema:
          type: integer
      responses:
        "200":
          description: the manifest
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestOut'
                x-content-type: application/json
        "400":
          description: bad input parameter
        "403":
          description: user not authorised to use this function
        "404":
          description: manifest does not exist
      x-openapi-router-controller: swagger_server.controllers.submitters_controller
  /manifests/{manifestId}/validate:
    get:
      security:
        - ApiKeyAuth: []
      tags:
      - submitters
      summary: Validates a manifest
      description: |
        Validates against: ENA checklist, ToLID species, family, genus, order
      operationId: validate_manifest
      parameters:
      - name: manifestId
        in: path
        description: a manifest ID (given when manifest created)
        required: true
        style: simple
        explode: true
        schema:
          type: integer
      responses:
        "200":
          description: validation results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestValidationResult'
                x-content-type: application/json
        "400":
          description: bad input parameter
        "403":
          description: user not authorised to use this function
        "404":
          description: manifest does not exist
      x-openapi-router-controller: swagger_server.controllers.submitters_controller
  /manifests/{manifestId}/generate:
    patch:
      security:
        - ApiKeyAuth: []
      tags:
      - submitters
      summary: Generates ToLIDs and BioSample IDs for a manifest
      description: |
        Calls out to ToLID service and ENA service
      operationId: generate_ids_for_manifest
      parameters:
      - name: manifestId
        in: path
        description: a manifest ID (given when manifest created)
        required: true
        style: simple
        explode: true
        schema:
          type: integer
      responses:
        "200":
          description: manifest with IDs filled in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestOut'
                x-content-type: application/json
        "400":
          description: errors in generating IDs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestValidationResult'
                x-content-type: application/json
        "403":
          description: user not authorised to use this function
        "404":
          description: manifest does not exist
      x-openapi-router-controller: swagger_server.controllers.submitters_controller
  /manifests/{manifestId}/download-excel:
    get:
      security:
        - ApiKeyAuth: []
      tags:
      - submitters
      summary: Downloads an excel file for the manifest, with ID columns filled in
      description: |
        Will use original manifest excel file, if manifest was uploaded from Excel
      operationId: download_manifest_excel
      parameters:
      - name: manifestId
        in: path
        description: a manifest ID (given when manifest created)
        required: true
        style: simple
        explode: true
        schema:
          type: integer
      responses:
        "200":
          description: An Excel file, with the IDs filled in (if generate endpoint has been called previously)
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        "403":
          description: user not authorised to use this function
        "404":
          description: manifest does not exist
      x-openapi-router-controller: swagger_server.controllers.submitters_controller
  /manifests/generate:
    post:
      security:
        - ApiKeyAuth: []
      tags:
      - submitters
      summary: Upload a JSON manifest and immediately generate IDs for its samples
      description: |
        Upload a manifest in JSON format and validate it (convenience method)
      operationId: submit_and_generate_manifest_json
      requestBody:
        description: Manifest to upload and validate
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ManifestIn'
      responses:
        "200":
          description: manifest with IDs filled in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestOut'
                x-content-type: application/json
        "400":
          description: errors in generating IDs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestValidationResult'
                x-content-type: application/json
        "403":
          description: user not authorised to use this function
      x-openapi-router-controller: swagger_server.controllers.submitters_controller
  /auth/login:
    get:
      tags:
      - auth
      summary: Get the Elixir login URL
      description: |
        Get the URL for logging in to Elixir
      operationId: login
      responses:
        "200":
          description: details of Elixir login URL
          content:
            application/json:
              schema:
                  type: object
                  properties:
                    loginUrl:
                      type: string
        "400":
          description: bad input parameter
      x-openapi-router-controller: swagger_server.controllers.auth_controller
  /auth/token:
    post:
      tags:
      - auth
      summary: Get an Elixir authorisation token
      description: |
        Get the URL for logging in to Elixir
      operationId: get_token_from_callback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code:
                  type: string
                state:
                  type: string
      responses:
        "200":
          description: authorisation token from Elixir
          content:
            application/json:
              schema:
                  type: object
                  properties:
                    token:
                      type: string
        "400":
          description: bad input parameter
      x-openapi-router-controller: swagger_server.controllers.auth_controller
  /auth/profile:
    post:
      tags:
      - auth
      summary: Get a user profile
      description: |
        Get the URL for logging in to Elixir
      operationId: create_user_profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
      responses:
        "200":
          description: user
          content:
            application/json:
              schema:
                  $ref: '#/components/schemas/User'
        "400":
          description: bad input parameter
      x-openapi-router-controller: swagger_server.controllers.auth_controller
components:
  schemas:
    ManifestIn: &manifest
      required:
        - samples
      type: object
      properties:
        samples:
          type: array
          items:
            $ref: '#/components/schemas/SampleIn'
        projectName:
          type: string
          example: SuperProject
        stsManifestId:
          type: string
          example: 1234-5678-90
      example:
        samples: &manifest_samples_example
          - row: 1
            SPECIMEN_ID: SAN000100
            TAXON_ID: 6344
            SCIENTIFIC_NAME: Arenicola marina
            GENUS: Arenicola
            FAMILY: Arenicolidae
            ORDER_OR_GROUP: None
            COMMON_NAME: lugworm
            LIFESTAGE: ADULT
            SEX: FEMALE
            ORGANISM_PART: MUSCLE
            GAL: SANGER INSTITUTE
            GAL_SAMPLE_ID: SAN000100
            COLLECTED_BY: ALEX COLLECTOR
            COLLECTOR_AFFILIATION: THE COLLECTOR INSTITUTE
            DATE_OF_COLLECTION: 2020-09-01
            COLLECTION_LOCATION: UNITED KINGDOM | DARK FOREST
            DECIMAL_LATITUDE: "+50.12345678"
            DECIMAL_LONGITUDE: "-1.98765432"
            HABITAT: Woodland
            IDENTIFIED_BY: JO IDENTIFIER
            IDENTIFIER_AFFILIATION: THE IDENTIFIER INSTITUTE
            VOUCHER_ID: voucher1
            ELEVATION: "0"
            DEPTH: "100"
        projectName: SuperProject
        stsManifestId: 1234-5678-90
    ManifestOut:
      <<: *manifest
      properties:
        samples:
          type: array
          items:
            $ref: '#/components/schemas/SampleOut'
        manifestId:
          type: string
          example: manifest12345
        submissionStatus:
          type: boolean
          example: true
      example:
        samples:
          <<: *manifest_samples_example
          tolId: wuAreMari1
          biosampleAccession: SAMEA12345678
          sraAccession: ERS1234
          submissionAccession: ERA5678
          sampleDerivedFrom: SAMEA87654321
          sampleSameAs: null
          sampleSymbiontOf: null
        manifestId: 123
        submissionStatus: false
    SampleIn: &sample
      required:
        - row
        - SPECIMEN_ID
        - TAXON_ID
        - SCIENTIFIC_NAME
        - GENUS
        - FAMILY
        - ORDER_OR_GROUP
        - LIFESTAGE
        - SEX
        - ORGANISM_PART
        - GAL
        - GAL_SAMPLE_ID
        - COLLECTED_BY
        - COLLECTOR_AFFILIATION
        - DATE_OF_COLLECTION
        - COLLECTION_LOCATION
        - DECIMAL_LATITUDE
        - DECIMAL_LONGITUDE
        - HABITAT
        - IDENTIFIED_BY
        - IDENTIFIER_AFFILIATION
        - VOUCHER_ID
      type: object
      properties: &sample_properties
        row:
          type: integer
          example: 1
        SPECIMEN_ID:
          type: string
          example: SAN000100
        TAXON_ID:
          type: integer
          example: 6344
        SCIENTIFIC_NAME:
          type: string
          example: Arenicola marina
        GENUS:
          type: string
          example: Arenicola
        FAMILY:
          type: string
          example: Arenicolidae
        ORDER_OR_GROUP:
          type: string
          example: None
        COMMON_NAME:
          type: string
          example: lugworm
        LIFESTAGE:
          type: string
          example: ADULT
        SEX:
          type: string
          example: FEMALE
        ORGANISM_PART:
          type: string
          example: MUSCLE
        GAL:
          type: string
          example: SANGER INSTITUTE
        GAL_SAMPLE_ID:
          type: string
          example: SAN000100
        COLLECTED_BY:
          type: string
          example: ALEX COLLECTOR
        COLLECTOR_AFFILIATION:
          type: string
          example: THE COLLECTOR INSTITUTE
        DATE_OF_COLLECTION:
          type: string
          example: 2020-09-01
        COLLECTION_LOCATION:
          type: string
          example: UNITED KINGDOM | DARK FOREST
        DECIMAL_LATITUDE:
          type: string
          example: "+50.12345678"
        DECIMAL_LONGITUDE:
          type: string
          example: "-1.98765432"
        HABITAT:
          type: string
          example: Woodland
        IDENTIFIED_BY:
          type: string
          example: JO IDENTIFIER
        IDENTIFIER_AFFILIATION:
          type: string
          example: THE IDENTIFIER INSTITUTE
        VOUCHER_ID:
          type: string
          example: voucher1
        ELEVATION:
          type: string
          example: "1500"
        DEPTH:
          type: string
          example: "100"
        RELATIONSHIP:
          type: string
          example: host
        SYMBIONT:
          type: string
          example: N
        CULTURE_OR_STRAIN_ID:
          type: string
          example: ABC1234
      example: &sample_example
        SPECIMEN_ID: SAN000100
        TAXON_ID: 6344
        SCIENTIFIC_NAME: Arenicola marina
        GENUS: Arenicola
        FAMILY: Arenicolidae
        ORDER_OR_GROUP: None
        COMMON_NAME: lugworm
        LIFESTAGE: ADULT
        SEX: FEMALE
        ORGANISM_PART: MUSCLE
        GAL: SANGER INSTITUTE
        GAL_SAMPLE_ID: SAN000100
        COLLECTED_BY: ALEX COLLECTOR
        COLLECTOR_AFFILIATION: THE COLLECTOR INSTITUTE
        DATE_OF_COLLECTION: 2020-09-01
        COLLECTION_LOCATION: UNITED KINGDOM | DARK FOREST
        DECIMAL_LATITUDE: "+50.12345678"
        DECIMAL_LONGITUDE: "-1.98765432"
        HABITAT: Woodland
        IDENTIFIED_BY: JO IDENTIFIER
        IDENTIFIER_AFFILIATION: THE IDENTIFIER INSTITUTE
        VOUCHER_ID: voucher1
        ELEVATION: "0"
        DEPTH: "100"
        RELATIONSHIP: child of SAMEA1234567
        SYMBIONT: "N"
        CULTURE_OR_STRAIN_ID: ABC1234
    SampleOut:
      <<: *sample
      required:
        - row
        - SPECIMEN_ID
        - TAXON_ID
        - SCIENTIFIC_NAME
        - GENUS
        - FAMILY
        - ORDER_OR_GROUP
        - LIFESTAGE
        - SEX
        - ORGANISM_PART
        - GAL
        - GAL_SAMPLE_ID
        - COLLECTED_BY
        - COLLECTOR_AFFILIATION
        - DATE_OF_COLLECTION
        - COLLECTION_LOCATION
        - DECIMAL_LATITUDE
        - DECIMAL_LONGITUDE
        - HABITAT
        - IDENTIFIED_BY
        - IDENTIFIER_AFFILIATION
        - VOUCHER_ID
        - tolId
        - biosampleAccession
        - sraAccession
        - submissionAccession
        - sampleDerivedFrom
        - sampleSameAs
        - sampleSymbiontOf
      properties:
        <<: *sample_properties
        tolId:
          type: string
          example: wuAreMari1
        biosampleAccession:
          type: string
          example: SAMEA12345678
        sraAccession:
          type: string
          example: ERS6206028
        submissionAccession:
          type: string
          example: ERA3819349
        submissionError:
          type: string
          example: "The object being added already exists in the submission account with accession: \"ERS6206044\"."
        sampleDerivedFrom:
          type: string
          example: "SAMEA87654321"
        sampleSameAs:
          type: string
          example: "SAMEA87654321"
        sampleSymbiontOf:
          type: string
          example: "SAMEA87654321"
      example:
        <<: *sample_example
        tolId: wuAreMari1
        biosampleAccession: SAMEA12345678
        sraAccession: ERS6206028
        submissionAccession: ERA3819349
        submissionError: null
        sampleDerivedFrom: SAMEA87654321
        sampleSameAs: null
        sampleSymbionOf: null
    User:
      required:
        - name
        - email
        - organisation
        - roles
      type: object
      properties:
        name:
          type: string
          example: "A User"
        email:
          type: string
          example: "user@example.com"
        organisation:
          type: string
          example: "Research Inc"
        roles:
          type: array
          items:
            $ref: '#/components/schemas/Role'
      example:
        name: "A User"
        email: "user@example.com"
        organisation: "Research Inc"
        roles:
    Role:
      required:
        - role
      type: object
      properties:
        role:
          type: string
          example: "creator"
      example:
        role: "creator"
    ManifestValidationResult:
      required:
        - manifestId
        - number_of_errors
        - validations
      type: object
      properties:
        manifestId:
          type: integer
          example: 1234
        number_of_errors:
          type: integer
          example: 1
        validations:
          type: array
          items:
            $ref: '#/components/schemas/SampleValidationResult'
    SampleValidationResult:
      required:
        - row
        - results
      type: object
      properties:
        row:
          type: integer
          example: 1
        results:
          type: array
          items:
            $ref: '#/components/schemas/SampleFieldValidationResult'
    SampleFieldValidationResult:
      required:
        - field
        - message
        - severity
      type: object
      properties:
        field:
          type: string
          example: "SPECIMEN_ID"
        message:
          type: string
          example: "Fails regex check"
        severity:
          type: string
          enum: [ERROR,WARNING]
          example: "ERROR"
  securitySchemes:
    ApiKeyAuth:        # name for the security scheme
      type: apiKey
      in: header       # can be "header", "query" or "cookie"
      name: api-key    # name of the header, query parameter or cookie
      x-apikeyInfoFunc: swagger_server.controllers.auth_controller.apikey_auth
# security:
#   - ApiKeyAuth: []     # 2) Apply the API key globally to all operations
  